<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Run R Code with WebR</title>
    <script type="module">
        hljs.highlightAll();

        // import { WebR } from './node_modules/webr/dist/webr.mjs';
        import { WebR } from 'https://webr.r-wasm.org/latest/webr.mjs';

        let webr;

        // Initialize WebR
        async function initializeWebR() {
            webr = new WebR();
            await webr.init();
            console.log('WebR initialized');
        }

        let ninputs=10

        // Function to evaluate R code from user input
        async function evaluateRCode() {
            if (!webr) {
                alert("WebR is not initialized yet!");
                return;
            }

            // Get the user input from the six input boxes
            const inputs = [];
            for (let i = 1; i <= ninputs; i++) {
                const inputVal = document.getElementById(`input${i}`).value;
                if (inputVal.trim()) {
                    inputs.push(inputVal);  // Only push non-empty inputs
                }
            }

            if (inputs.length === 0) {
                alert("Please fill in at least one input field.");
                return;
            }

            // Prepare the R code to concatenate the inputs
            const userCode = `paste0(${inputs.join(", ")})`;
            console.log("Generated R code:", userCode);

            try {
                // Evaluate the user-provided R code
                const result = await webr.evalR(userCode);

                // Convert result to an array
                const outputArray = await result.toArray();

                // Join the output array with newline characters and display it
                document.getElementById('output').innerHTML = outputArray.join("\n");
                // Apply highlight.js to the output element
                
                // Append the generated R code to the previous code in the generatedCode block
                const previousCode = document.getElementById('generatedCode').innerText;
                console.log("Previouscode=", previousCode)
                if (previousCode === "" ) {
                    document.getElementById('generatedCode').innerHTML = userCode;
                } else {
                    const updatedCode = previousCode + "\n" + userCode;
                    document.getElementById('generatedCode').innerHTML = updatedCode;
                }
                
                hljs.highlightAll();

            } catch (error) {
                console.error('Error evaluating R code:', error);
                alert('Failed to evaluate R code. Please check your input.');
            }
        }

        // Function to copy the output to clipboard (not the R code)
        function copyToClipboard() {
            const output = document.getElementById('output').innerText;
            if (output) {
                // Create a temporary textarea element to copy the content
                const textarea = document.createElement("textarea");
                textarea.value = output;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
            }
        }

        // Function to fill input fields with example values
        function loadExample1() {
            document.getElementById('input1').value = "201:210";
            document.getElementById('input2').value = '";Lap"';
            document.getElementById('input3').value = "1:10";
            document.getElementById('input4').value = '";;0;;T"';
            document.getElementById('input5').value = "101:110";
            document.getElementById('input6').value = '"-T"';
            document.getElementById('input7').value = '(101:110)-1';
            evaluateRCode();
        }
        function loadExample2() {
            document.getElementById('input1').value = "2002:2100";
            document.getElementById('input2').value = '";Control"';
            document.getElementById('input3').value = "2:100";
            document.getElementById('input4').value = '";;0;CONTROL;(RAWDATA)\\n 0;0;0;"';
            document.getElementById('input5').value = "101:149";
            document.getElementById('input6').value = '";30;-1;0"';
            document.getElementById('input7').value = '';
            evaluateRCode();
        }

        // Function to reset all input fields
        function resetInputs() {
            for (let i = 1; i <= ninputs; i++) {
                document.getElementById(`input${i}`).value = '';
            }
            document.getElementById("output").innerHTML = '';
        }

        // Expose functions to the global scope
        window.initializeWebR = initializeWebR;
        window.evaluateRCode = evaluateRCode;
        window.copyToClipboard = copyToClipboard;
        window.loadExample1 = loadExample1;
        window.loadExample2 = loadExample2;
        window.resetInputs = resetInputs;


        // Automatically initialize WebR
        window.addEventListener('load', initializeWebR);
    </script>
    <!-- Include highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark-reasonable.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        
    <style>
        /* Ensure all input boxes are displayed in a single row with scrolling if necessary */
        * {
            font-family: monospace;
        }
        code {
            border-radius: 5px;
        }
        .input-container {
            display: flex;
            flex-wrap: nowrap;
            gap: 10px;
            overflow-x: auto;
        }
        .input-container input {
            padding: 8px;
            width: 150px;
            min-width: 150px;
        }
        .flex{
            display:flex;
            column-gap: 1em;
            /* justify-content: space-between; */
            align-items:center;
        }
        p {
            margin-block-start: 0.1em;
            margin-block-end: 0.1em;
        }
        pre {
            padding: 0em;
        }
    </style>
    <style>
        html {
            background-color: #2c2b29 !important;
        }
        html {
            color-scheme: dark !important;
        }
        iframe {
            color-scheme: dark !important;
        }
        html, body {
            background-color: #2c2b29;
        }
        html, body {
            border-color: #7e7565;
            color: #ede4d3;
        }
        a {
            color: #5c94d2;
        }
        table {
            border-color: #656661;
        }
        mark {
            color: #ede4d3;
        }
    </style>



</head>
<body>
    <h1>Special Result Builder</h1>
    <p style="font-style: italic;">Code created by <a href="https://dgrv.github.io/dorian-gravier/">Dorian Gravier</a> with the help of <a href="https://chatgpt.com/">ChatGPT</a></p>
    <div class="flex">
        <p>The input boxes will permit you to use R code that will be run in the form of </p>
        <pre><code class="language-r">paste0(input1, input2, input3, ...)</code></pre>
    </div>
    <p>The inputs can be numerical (witout quote: 1, 2, 10+1, 1:10, 10:1) or strings (with quotes: "Hello world", "Finish;0;0;1") </p> 

    <div class="flex">
        <button id="example1" onclick="loadExample1()">Load Example1</button>
        <pre><code class="language-r">paste0(201:210, ";Lap", 1:10, ";;0;;T", 101:110, "-T", (101:110)-1)</code></pre>
    </div>
    <div class="flex">
        <button id="example2" onclick="loadExample2()">Load Example2</button> 
        <pre><code class="language-r">paste0(2002:2100, ";Control", 2:100, ";;0;CONTROL;(RAWDATA)\n 0;0;0;", 101:149, ";30;-1;0")</code></pre>
    </div>

    <br>
    <!-- Input boxes for user values -->
    <div class="input-container">
        <input type="text" id="input1" placeholder="Enter value for input1">
        <input type="text" id="input2" placeholder="input2">
        <input type="text" id="input3" placeholder="input3">
        <input type="text" id="input4" placeholder="input4">
        <input type="text" id="input5" placeholder="input5">
    </div>
    <br>
    <div class="input-container">
        <input type="text" id="input6" placeholder="input6">
        <input type="text" id="input7" placeholder="input7">
        <input type="text" id="input8" placeholder="input8">
        <input type="text" id="input9" placeholder="input9">
        <input type="text" id="input10" placeholder="input10">
    </div>
    <br>
    
    <!-- Button to run the R code -->
    <button id="runR">Run Code</button>
    <button id="reset" onclick="resetInputs()">Reset</button>
    
    <!-- Display the generated R code -->
    <h3>Generated R Code:</h3>
    <pre><code id="generatedCode" class="language-r"></code></pre>

    <!-- Copy button for clipboard (copies output, not R code) -->
    <button id="copyCode" onclick="copyToClipboard()">Copy Output to Clipboard</button>

    <!-- Display the output -->
    <h3>Output:</h3>
    <pre><code id="output" class="language-less">Output will appear here...</code></pre>



    <script>
        // Attach the button click event to the function
        document.getElementById('runR').addEventListener('click', () => {
            if (typeof window.evaluateRCode === 'function') {
                window.evaluateRCode();
            } else {
                alert("WebR app is not ready yet.");
            }
        });

        // Add event listener for Enter key on all input fields to trigger evaluateRCode
        document.querySelectorAll('.input-container input').forEach(input => {
            input.addEventListener('keydown', function(event) {
                if (event.key === "Enter") {
                    evaluateRCode();
                }
            });
        });
    </script>
</body>
</html>
